!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["video/danmaku/download"]=e():t["video/danmaku/download"]=e()}(self,(function(){return function(){var __webpack_modules__={266:function(__unused_webpack_module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{proto:function(){return proto},decodeDanmakuSegment:function(){return decodeDanmakuSegment},decodeDanmakuView:function(){return decodeDanmakuView}});var _core_ajax__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(663),_core_ajax__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(_core_ajax__WEBPACK_IMPORTED_MODULE_0__),_core_toast__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(141),_core_toast__WEBPACK_IMPORTED_MODULE_1___default=__webpack_require__.n(_core_toast__WEBPACK_IMPORTED_MODULE_1__),_core_utils_log__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(729),_core_utils_log__WEBPACK_IMPORTED_MODULE_2___default=__webpack_require__.n(_core_utils_log__WEBPACK_IMPORTED_MODULE_2__);const proto={nested:{DmWebViewReply:{fields:{state:{type:"int32",id:1},text:{type:"string",id:2},textSide:{type:"string",id:3},dmSge:{type:"DmSegConfig",id:4},flag:{type:"DanmakuFlagConfig",id:5},specialDms:{rule:"repeated",type:"string",id:6},checkBox:{type:"bool",id:7},count:{type:"int64",id:8},commandDms:{rule:"repeated",type:"CommandDm",id:9},dmSetting:{type:"DanmuWebPlayerConfig",id:10}}},CommandDm:{fields:{id:{type:"int64",id:1},oid:{type:"int64",id:2},mid:{type:"int64",id:3},command:{type:"string",id:4},content:{type:"string",id:5},progress:{type:"int32",id:6},ctime:{type:"string",id:7},mtime:{type:"string",id:8},extra:{type:"string",id:9},idStr:{type:"string",id:10}}},DmSegConfig:{fields:{pageSize:{type:"int64",id:1},total:{type:"int64",id:2}}},DanmakuFlagConfig:{fields:{recFlag:{type:"int32",id:1},recText:{type:"string",id:2},recSwitch:{type:"int32",id:3}}},DmSegMobileReply:{fields:{elems:{rule:"repeated",type:"DanmakuElem",id:1}}},DanmakuElem:{fields:{id:{type:"int64",id:1},progress:{type:"int32",id:2},mode:{type:"int32",id:3},fontsize:{type:"int32",id:4},color:{type:"uint32",id:5},midHash:{type:"string",id:6},content:{type:"string",id:7},ctime:{type:"int64",id:8},weight:{type:"int32",id:9},action:{type:"string",id:10},pool:{type:"int32",id:11},idStr:{type:"string",id:12},attr:{type:"int32",id:13}}},DanmuWebPlayerConfig:{fields:{dmSwitch:{type:"bool",id:1},aiSwitch:{type:"bool",id:2},aiLevel:{type:"int32",id:3},blocktop:{type:"bool",id:4},blockscroll:{type:"bool",id:5},blockbottom:{type:"bool",id:6},blockcolor:{type:"bool",id:7},blockspecial:{type:"bool",id:8},preventshade:{type:"bool",id:9},dmask:{type:"bool",id:10},opacity:{type:"float",id:11},dmarea:{type:"int32",id:12},speedplus:{type:"float",id:13},fontsize:{type:"float",id:14},screensync:{type:"bool",id:15},speedsync:{type:"bool",id:16},fontfamily:{type:"string",id:17},bold:{type:"bool",id:18},fontborder:{type:"int32",id:19},drawType:{type:"string",id:20}}}}},decode=lodash.curry((async(type,blob,toastTitle="")=>{const buffer=new Uint8Array("arrayBuffer"in Blob.prototype?await blob.arrayBuffer():await new Response(blob).arrayBuffer());window.protobufPromise||(window.protobufPromise=new Promise(((resolve,reject)=>{(0,_core_ajax__WEBPACK_IMPORTED_MODULE_0__.monkey)({url:"https://cdn.jsdelivr.net/npm/protobufjs@6.10.1/dist/light/protobuf.min.js",method:"GET"}).catch((t=>(0,_core_utils_log__WEBPACK_IMPORTED_MODULE_2__.logError)(t))).then((library=>{if(!library){const t="加载依赖库失败, 请稍后重试.";_core_toast__WEBPACK_IMPORTED_MODULE_1__.Toast.error(t,toastTitle||"错误"),reject(t)}eval(library),resolve(window.protobuf)}))})));const protobuf=await window.protobufPromise,root=protobuf.Root.fromJSON(proto),reply=root.lookupType(type),message=reply.decode(buffer);return reply.toObject(message)})),decodeDanmakuSegment=decode("DmSegMobileReply"),decodeDanmakuView=decode("DmWebViewReply")},845:function(t,e,i){"use strict";i.r(e),i.d(e,{JsonDanmaku:function(){return v},convertToAss:function(){return w},convertToAssFromJson:function(){return S},getBlobByType:function(){return T},getUserDanmakuConfig:function(){return k}});var o=coreApis.utils.lazyPanel,n=i(729),r=coreApis.utils.sort,a=i(129);function s(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class c{constructor({content:t,time:e,type:i,fontSize:o,color:n}){s(this,"content",void 0),s(this,"time",void 0),s(this,"startTime",void 0),s(this,"type",void 0),s(this,"fontSize",void 0),s(this,"color",void 0),this.content=t,this.time=e,this.startTime=parseFloat(e),this.type=parseInt(i),this.fontSize=parseFloat(o),this.color=parseInt(n)}}function l(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class d extends c{constructor({content:t,time:e,type:i,fontSize:o,color:n,typeTag:r,colorTag:a,endTime:s}){super({content:t,time:e,type:i,fontSize:o,color:n}),l(this,"typeTag",void 0),l(this,"colorTag",void 0),l(this,"endTime",void 0),this.typeTag=r,this.colorTag=a,this.endTime=s}text(t){let e=t[this.fontSize];e||(e=t[25]);const i=e.match(/Style:(.*?),/)[1].trim();return`Dialogue: 0,${this.time},${this.endTime},${i},,0,0,0,,{${this.typeTag}${this.colorTag}}${this.content}`}}class u{constructor(t,e,i,o,n){l(this,"danmakus",void 0),l(this,"title",void 0),l(this,"fontStyles",void 0),l(this,"blockTypes",void 0),l(this,"resolution",void 0),this.danmakus=t,this.title=e,this.fontStyles=i,this.blockTypes=o,this.resolution=n}generateAss(){return`${`\n[Script Info]\n; Script generated by Bilibili Evolved Danmaku Converter\n; https://github.com/the1812/Bilibili-Evolved/\nTitle: ${this.title}\nScriptType: v4.00+\nPlayResX: ${this.resolution.x}\nPlayResY: ${this.resolution.y}\nTimer: 10.0000\nWrapStyle: 2\nScaledBorderAndShadow: no\n\n[V4+ Styles]\nFormat: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding\n${Object.values(this.fontStyles).join("\n")}\n\n[Events]\nFormat: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text\n                `.trim()}\n${this.danmakus.map((t=>t.text(this.fontStyles))).filter((t=>""!==t)).join("\n")}`}}function p(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class h extends c{constructor({content:t,time:e,type:i,fontSize:o,color:n,timeStamp:r,pool:a,userHash:s,rowId:c}){super({content:t,time:e,type:i,fontSize:o,color:n}),p(this,"timeStamp",void 0),p(this,"pool",void 0),p(this,"userHash",void 0),p(this,"rowId",void 0),p(this,"pDataArray",void 0),this.timeStamp=parseInt(r),this.pool=parseInt(a),this.userHash=s,this.rowId=parseInt(c),this.pDataArray=[e,i,o,n,r,a,s,c]}text(){return`<d p="${this.pDataArray.join(",")}">${this.content}</d>`}static parse(t){const e=t.getAttribute("p"),[i,o,n,r,a,s,c,l]=e.split(","),d=t.innerHTML;return new h({content:d,time:i,type:o,fontSize:n,color:r,timeStamp:a,pool:s,userHash:c,rowId:l})}}class m{constructor(t){p(this,"xml",void 0),p(this,"danmakus",void 0),this.xml=t;const e=(new DOMParser).parseFromString(t,"application/xml").documentElement;this.danmakus=[...e.querySelectorAll("d[p]")].map((t=>h.parse(t)))}}let _;function f(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}!function(t){t[t.Normal=1]="Normal",t[t.Normal2=2]="Normal2",t[t.Normal3=3]="Normal3",t[t.Bottom=4]="Bottom",t[t.Top=5]="Top",t[t.Reversed=6]="Reversed",t[t.Special=7]="Special",t[t.Special2=8]="Special2"}(_||(_={}));class g{constructor(t,e,i,o){f(this,"horizontalStack",void 0),f(this,"horizontalTrack",void 0),f(this,"verticalStack",void 0),f(this,"verticalTrack",void 0),f(this,"resolution",void 0),f(this,"duration",void 0),f(this,"canvas",void 0),f(this,"context",void 0),f(this,"fontSizes",void 0),f(this,"bottomMarginPercent",void 0),f(this,"danmakuHeight",void 0),f(this,"trackHeight",void 0),f(this,"trackCount",void 0),this.horizontalStack=[],this.horizontalTrack=[],this.verticalStack=[],this.verticalTrack=[],this.resolution=e,this.duration=i,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.fontSizes={30:`64px ${t}`,25:`52px ${t}`,18:`36px ${t}`,45:`90px ${t}`},this.bottomMarginPercent=o,this.generateTracks()}generateTracks(){this.danmakuHeight=52,this.trackHeight=2*g.margin+52,this.trackCount=parseInt(coreApis.utils.fixed(this.resolution.y*(1-this.bottomMarginPercent)/this.trackHeight,0))}getTextSize(t){this.context.font=this.fontSizes[t.fontSize];return[this.context.measureText(t.content).width/2,this.danmakuHeight/2]}getTags(t,{targetTrack:e,initTrackNumber:i,nextTrackNumber:o,willOverlay:n,getTrackItem:r,getTag:a}){const[s,c]=this.getTextSize(t),l=2*s,d=this.duration(t)*l/(this.resolution.x+l)+g.nextDanmakuDelay;let u=i,p=null;do{p=e.find((t=>n(t,u,l))),u+=o}while(p&&u<=this.trackCount&&u>=0);return u>this.trackCount||u<0?"\\pos(0,-999)":(u-=o,e.push(r(u,l,d)),a({trackNumber:u,x:s,y:c}))}getHorizontalTags(t){return this.getTags(t,{targetTrack:this.horizontalTrack,initTrackNumber:0,nextTrackNumber:1,willOverlay:(e,i,o)=>e.trackNumber===i&&(e.width<o?this.duration(t)*this.resolution.x/(this.resolution.x+o)<=e.end-t.startTime:e.visible>t.startTime),getTrackItem:(e,i,o)=>({width:i,start:t.startTime,visible:t.startTime+o,end:t.startTime+this.duration(t),trackNumber:e}),getTag:({trackNumber:e,x:i,y:o})=>`\\move(${this.resolution.x+i},${e*this.trackHeight+g.margin+o},${-i},${e*this.trackHeight+g.margin+o},0,${1e3*this.duration(t)})`})}getVerticalTags(t){const e="top"===g.danmakuType[t.type];return this.getTags(t,{targetTrack:this.verticalTrack,initTrackNumber:e?0:this.trackCount-1,nextTrackNumber:e?1:-1,willOverlay:(e,i)=>e.trackNumber===i&&e.end>t.startTime,getTrackItem:e=>({start:t.startTime,end:t.startTime+this.duration(t),trackNumber:e}),getTag:({trackNumber:t,y:i})=>e?`\\pos(${this.resolution.x/2},${t*this.trackHeight+g.margin+i})`:`\\pos(${this.resolution.x/2},${this.resolution.y-g.margin-i-(this.trackCount-1-t)*this.trackHeight})`})}push(t){let e="",i=[];switch(g.danmakuType[t.type]){case"normal":case"reversed":e=this.getHorizontalTags(t),i=this.horizontalStack;break;case"top":case"bottom":e=this.getVerticalTags(t),i=this.verticalStack;break;case"special":default:return{tags:"\\pos(0,-999)"}}const o={tags:e};return i.push(o),o}}function b(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}
/* eslint-disable */f(g,"danmakuType",{[_.Normal]:"normal",[_.Normal2]:"normal",[_.Normal3]:"normal",[_.Bottom]:"bottom",[_.Top]:"top",[_.Reversed]:"reversed",[_.Special]:"special",[_.Special2]:"special"}),f(g,"margin",4),f(g,"nextDanmakuDelay",.05);class y{constructor({title:t,font:e,alpha:i,duration:o,blockTypes:n,blockFilter:r,resolution:a,bottomMarginPercent:s,bold:c}){b(this,"title",void 0),b(this,"font",void 0),b(this,"alpha",void 0),b(this,"duration",void 0),b(this,"blockTypes",void 0),b(this,"blockFilter",void 0),b(this,"resolution",void 0),b(this,"bold",void 0),b(this,"danmakuStack",void 0),this.title=t,this.font=e,this.alpha=Math.round(255*i).toString(16).toUpperCase().padStart(2,"0"),this.duration=o,this.blockTypes=n,this.blockFilter=r||(()=>!0),this.resolution=a,this.bold=c,this.danmakuStack=new g(e,a,o,s)}get fontStyles(){return{36:`Style: Larger,${this.font},72,&H${this.alpha}FFFFFF,&H${this.alpha}FFFFFF,&H${this.alpha}000000,&H${this.alpha}000000,${this.bold?"1":"0"},0,0,0,100,100,0,0,1,1.2,0,5,0,0,0,0`,30:`Style: Large,${this.font},64,&H${this.alpha}FFFFFF,&H${this.alpha}FFFFFF,&H${this.alpha}000000,&H${this.alpha}000000,${this.bold?"1":"0"},0,0,0,100,100,0,0,1,1.2,0,5,0,0,0,0`,25:`Style: Medium,${this.font},52,&H${this.alpha}FFFFFF,&H${this.alpha}FFFFFF,&H${this.alpha}000000,&H${this.alpha}000000,${this.bold?"1":"0"},0,0,0,100,100,0,0,1,1.2,0,5,0,0,0,0`,18:`Style: Small,${this.font},36,&H${this.alpha}FFFFFF,&H${this.alpha}FFFFFF,&H${this.alpha}000000,&H${this.alpha}000000,${this.bold?"1":"0"},0,0,0,100,100,0,0,1,1.2,0,5,0,0,0,0`,45:`Style: ExtraLarge,${this.font},90,&H${this.alpha}FFFFFF,&H${this.alpha}FFFFFF,&H${this.alpha}000000,&H${this.alpha}000000,${this.bold?"1":"0"},0,0,0,100,100,0,0,1,1.2,0,5,0,0,0,0`}}xmlDanmakuToAssDocument(t){const e=[];for(const i of t){if(-1!==this.blockTypes.indexOf(i.type)||-1!==this.blockTypes.indexOf("color")&&i.color!==y.white)continue;if(!this.blockFilter(i))continue;const[t,o]=this.convertTime(i.startTime,this.duration(i));e.push(new d({content:this.convertText(i.content),time:t,endTime:o,type:i.type.valueOf().toString(),fontSize:i.fontSize.toString(),color:i.color.toString(),typeTag:this.convertType(i),colorTag:this.convertColor(i.color)}))}return new u(e,this.title,this.fontStyles,this.blockTypes,this.resolution)}xmlStringToAssDocument(t){const e=new m(t);return this.xmlDanmakuToAssDocument(e.danmakus.sort(((t,e)=>t.startTime-e.startTime)))}convertText(t){const e={"{":"｛","}":"｝","&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};for(const[i,o]of Object.entries(e))t=t.replace(new RegExp(i,"g"),o);return t}convertType(t){return this.danmakuStack.push(t).tags}convertColor(t){if(t===y.white)return"";const e=t.toString(16),i=e.substring(0,2),o=e.substring(2,4);return`\\c&H${e.substring(4,6)}${o}${i}&`}convertTime(t,e){function i(t){let e=0,i=0;for(;t>=60;)t-=60,i++;for(;i>=60;)i-=60,e++;return`${e}:${String(i).padStart(2,"0")}:${function(t){const[e,i="00"]=String(t).split(".");return`${e.padStart(2,"0")}.${i.substr(0,2).padEnd(2,"0")}`}(t)}`}return[i(t),i(t+e)]}}b(y,"white",16777215);class v{constructor(t,e){var i,o,n;this.aid=t,this.cid=e,n=[],(o="jsonDanmakus")in(i=this)?Object.defineProperty(i,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[o]=n}get xmlDanmakus(){return this.jsonDanmakus.map((t=>({content:t.content,time:t.progress?(t.progress/1e3).toString():"0",type:t.mode?.toString()??"1",fontSize:t.fontsize?.toString()??"25",color:t.color?.toString()??"16777215",timeStamp:t.ctime?.toString()??"0",pool:t.pool?.toString()??"0",userHash:t.midHash??"0",rowId:t.idStr??"0"})))}async fetchInfo(){const{decodeDanmakuSegment:t,decodeDanmakuView:e}=await Promise.resolve().then(i.bind(i,266)),o=async t=>(await fetch(t)).blob(),a=await o(`https://api.bilibili.com/x/v2/dm/web/view?type=1&oid=${this.cid}&pid=${this.aid}`);if(!a)throw new Error("获取弹幕信息失败");const s=await e(a),{total:c}=s.dmSge;if(void 0===c)throw new Error(`获取弹幕分页数失败: ${JSON.stringify(lodash.omit(s,"flag"))}`);console.log("segment count =",c);const l=await Promise.all(new Array(c).fill(0).map((async(e,i)=>{const r=await o(`https://api.bilibili.com/x/v2/dm/web/seg.so?type=1&oid=${this.cid}&pid=${this.aid}&segment_index=${i+1}`);if(!r)return(0,n.logError)(new Error(`弹幕片段${i+1}下载失败`)),[];console.log(`received blob for segment ${i+1}`,r);return(await t(r)).elems??[]})));return this.jsonDanmakus=l.flat().sort((0,r.ascendingSort)((t=>t.progress))),this}}const k=async()=>{const t=(0,a.getFriendlyTitle)(),e={font:"微软雅黑",alpha:.4,duration:t=>{switch(t.type){case 4:case 5:return 4;default:return 6}},blockTypes:[7,8],resolution:{x:1920,y:1080},bottomMarginPercent:.15,bold:!1};let i={...e,title:t};try{await(0,o.loadDanmakuSettingsPanel)();const t=localStorage.getItem("bilibili_player_settings");if(t){const e=JSON.parse(t),o=(t,i)=>lodash.get(e,`setting_config.${t}`,i);i.blockTypes=(()=>{const t=[],i={scroll:[1,2,3],top:[5],bottom:[4],color:["color"]};for(const[o,n]of Object.entries(i))!1===lodash.get(e,`block.type_${o}`,!0)&&t.push(...n);return t.concat(7,8)})(),i.bold=o("bold",!1),i.alpha=lodash.clamp(1-parseFloat(o("opacity","0.4")),0,1);const n=1.4-.4*o("fontsize",1);i.resolution={x:Math.round(1920*n),y:Math.round(1080*n)},i.duration=(()=>{const t=18-3*o("speedplus",0);return e=>{switch(e.type){case 4:case 5:return 4;default:return t}}})();const r=o("danmakuArea",0);i.bottomMarginPercent=r>=100?0:r/100,0===i.bottomMarginPercent&&o("preventshade",!1)&&(i.bottomMarginPercent=.15);const a=lodash.get(e,"block.list",[]);i.blockFilter=t=>{for(const e of a)if(e.s)switch(e.t){default:return!0;case"keyword":if(t.content.includes(e.v))return!1;break;case"regexp":if(new RegExp(e.v).test(t.content))return!1;break;case"user":if(t.userHash===e.v)return!1}return!0}}else console.warn("[弹幕转换] 未找到播放器设置"),i={...i,...e};i.font=dq(".bilibili-player-video-danmaku-setting-right-font .bui-select-result").innerText}catch(t){(0,n.logError)(t),i={...i,...e}}for(const[t,o]of Object.entries(i))null==o&&(console.warn("danmaku config invalid for key",t,", value =",o),i[t]=e[o]);return console.log(i),i},w=async t=>new y(await k()).xmlStringToAssDocument(t).generateAss(),S=async t=>new y(await k()).xmlDanmakuToAssDocument(t.xmlDanmakus.map((t=>new h(t)))).generateAss(),T=async(t,e=unsafeWindow)=>{const{aid:i,cid:o}=e,n=await new v(i,o).fetchInfo();switch(t){case"xml":return new Blob([n.xmlDanmakus.map((t=>new h(t).text())).join("\n")],{type:"text/xml"});default:case"json":return new Blob([JSON.stringify(n.jsonDanmakus)],{type:"text/json"});case"ass":return new Blob([await S(n)],{type:"text/ass"})}}},616:function(t,e,i){var o=i(645)((function(t){return t[1]}));o.push([t.id,".download-danmaku-config.download-video-config-section .be-dropdown {\n  text-transform: uppercase;\n}",""]),t.exports=o},645:function(t){"use strict";
// eslint-disable-next-line func-names
t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i=t(e);return e[2]?"@media ".concat(e[2]," {").concat(i,"}"):i})).join("")},
// eslint-disable-next-line func-names
e.i=function(t,i,o){"string"==typeof t&&(
// eslint-disable-next-line no-param-reassign
t=[[null,t,""]]);var n={};if(o)for(var r=0;r<this.length;r++){
// eslint-disable-next-line prefer-destructuring
var a=this[r][0];null!=a&&(n[a]=!0)}for(var s=0;s<t.length;s++){var c=[].concat(t[s]);o&&n[c[0]]||(i&&(c[2]?c[2]="".concat(i," and ").concat(c[2]):c[2]=i),e.push(c))}},e}},379:function(t,e,i){"use strict";var o,n=function(){return void 0===o&&(
// @see http://browserhacks.com/#hack-e71d8692f65334173fee715c222cb805
// @see https://github.com/webpack-contrib/style-loader/issues/177
o=Boolean(window&&document&&document.all&&!window.atob)),o},r=function(){var t={};return function(e){if(void 0===t[e]){var i=document.querySelector(e);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}t[e]=i}return t[e]}}(),a=[];function s(t){for(var e=-1,i=0;i<a.length;i++)if(a[i].identifier===t){e=i;break}return e}function c(t,e){for(var i={},o=[],n=0;n<t.length;n++){var r=t[n],c=e.base?r[0]+e.base:r[0],l=i[c]||0,d="".concat(c," ").concat(l);i[c]=l+1;var u=s(d),p={css:r[1],media:r[2],sourceMap:r[3]};-1!==u?(a[u].references++,a[u].updater(p)):a.push({identifier:d,updater:f(p,e),references:1}),o.push(d)}return o}function l(t){var e=document.createElement("style"),o=t.attributes||{};if(void 0===o.nonce){var n=i.nc;n&&(o.nonce=n)}if(Object.keys(o).forEach((function(t){e.setAttribute(t,o[t])})),"function"==typeof t.insert)t.insert(e);else{var a=r(t.insert||"head");if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(e)}return e}var d,u=(d=[],function(t,e){return d[t]=e,d.filter(Boolean).join("\n")});function p(t,e,i,o){var n=i?"":o.media?"@media ".concat(o.media," {").concat(o.css,"}"):o.css;if(t.styleSheet)t.styleSheet.cssText=u(e,n);else{var r=document.createTextNode(n),a=t.childNodes;a[e]&&t.removeChild(a[e]),a.length?t.insertBefore(r,a[e]):t.appendChild(r)}}function h(t,e,i){var o=i.css,n=i.media,r=i.sourceMap;if(n?t.setAttribute("media",n):t.removeAttribute("media"),r&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleSheet)t.styleSheet.cssText=o;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(o))}}var m=null,_=0;function f(t,e){var i,o,n;if(e.singleton){var r=_++;i=m||(m=l(e)),o=p.bind(null,i,r,!1),n=p.bind(null,i,r,!0)}else i=l(e),o=h.bind(null,i,e),n=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(i)};return o(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;o(t=e)}else n()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=n());var i=c(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var o=0;o<i.length;o++){var n=s(i[o]);a[n].references--}for(var r=c(t,e),l=0;l<i.length;l++){var d=s(i[l]);0===a[d].references&&(a[d].updater(),a.splice(d,1))}i=r}}}},24:function(t,e,i){"use strict";i.r(e),i.d(e,{default:function(){return p}});var o=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"multiple-widgets"},[i("DefaultWidget",{attrs:{disabled:t.disabled,name:"下载弹幕 (XML)",icon:"danmaku"},on:{click:function(e){return t.download("xml")}}}),t._v(" "),i("DefaultWidget",{attrs:{disabled:t.disabled,name:"下载弹幕 (JSON)",icon:"danmaku"},on:{click:function(e){return t.download("json")}}}),t._v(" "),i("DefaultWidget",{attrs:{disabled:t.disabled,name:"下载弹幕 (ASS)",icon:"danmaku"},on:{click:function(e){return t.download("ass")}}})],1)};o._withStripped=!0;var n=coreApis.download,r=i(729),a=i(129),s=coreApis.pluginApis.data,c=i(643),l=i(845);(0,s.addData)("ui.icons",(t=>{t.danmaku='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"  viewBox="0 0 24 24"><path d="M20,4H4C2.9,4,2,4.9,2,6v12c0,1.1,0.9,2,2,2h4h5.9H20c1.1,0,2-0.9,2-2V6C22,4.9,21.1,4,20,4z M5,7h8v2H5V7z M7,17H5v-2h2V17z M6.3,13v-2H18v2H6.3z M19,17H9v-2h10V17z M19,9h-4.1V7H19V9z"/></svg>'}));var d=Vue.extend({components:{DefaultWidget:c.DefaultWidget},data:()=>({disabled:!1}),methods:{async download(t){try{this.disabled=!0;const e=(0,a.getFriendlyTitle)(),i=await(0,l.getBlobByType)(t);await n.DownloadPackage.single(`${e}.${t}`,i)}catch(t){(0,r.logError)(t)}finally{this.disabled=!1}}}}),u=(0,i(900).Z)(d,o,[],!1,null,null,null);u.options.__file="registry/lib/components/video/danmaku/download/DownloadDanmaku.vue";var p=u.exports},637:function(t,e,i){"use strict";i.r(e),i.d(e,{default:function(){return m}});var o=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"download-danmaku-config download-video-config-section"},[i("div",{staticClass:"download-video-config-item"},[i("div",{staticClass:"download-video-config-title"},[t._v("\n      弹幕:\n    ")]),t._v(" "),i("VDropdown",{attrs:{items:t.items},scopedSlots:t._u([{key:"item",fn:function(e){var i=e.item;return[t._v("\n        "+t._s(i)+"\n      ")]}}]),model:{value:t.type,callback:function(e){t.type=e},expression:"type"}})],1)])};o._withStripped=!0;var n=coreApis.settings,r=i(643);const a=(0,n.getComponentSettings)("downloadVideo").options;var s=Vue.extend({components:{VDropdown:r.VDropdown},data:()=>({type:a.danmakuType??"无",items:["无","ass","json","xml"]}),computed:{enabled(){return"无"!==this.type}},watch:{type(t){a.danmakuType=t}}}),c=i(379),l=i.n(c),d=i(616),u=i.n(d),p={insert:"head",singleton:!1},h=(l()(u(),p),u().locals,(0,i(900).Z)(s,o,[],!1,null,null,null));h.options.__file="registry/lib/components/video/danmaku/download/Plugin.vue";var m=h.exports},900:function(t,e,i){"use strict";function o(t,e,i,o,n,r,a,s){var c,l="function"==typeof t?t.options:t;if(e&&(l.render=e,l.staticRenderFns=i,l._compiled=!0),o&&(l.functional=!0),r&&(l._scopeId="data-v-"+r),a?(c=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),n&&n.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(a)},l._ssrRegister=c):n&&(c=s?function(){n.call(this,(l.functional?this.parent:this).$root.$options.shadowRoot)}:n),c)if(l.functional){l._injectStyles=c;var d=l.render;l.render=function(t,e){return c.call(e),d(t,e)}}else{var u=l.beforeCreate;l.beforeCreate=u?[].concat(u,c):[c]}return{exports:t,options:l}}i.d(e,{Z:function(){return o}})},663:function(t){"use strict";t.exports=coreApis.ajax},141:function(t){"use strict";t.exports=coreApis.toast},643:function(t){"use strict";t.exports=coreApis.ui},729:function(t){"use strict";t.exports=coreApis.utils.log},129:function(t){"use strict";t.exports=coreApis.utils.title}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var i=__webpack_module_cache__[t]={id:t,exports:{}};return __webpack_modules__[t](i,i.exports,__webpack_require__),i.exports}__webpack_require__.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return __webpack_require__.d(e,{a:e}),e},__webpack_require__.d=function(t,e){for(var i in e)__webpack_require__.o(e,i)&&!__webpack_require__.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},__webpack_require__.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},__webpack_require__.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var __webpack_exports__={};return function(){"use strict";__webpack_require__.d(__webpack_exports__,{component:function(){return o}});var t=coreApis.spinQuery,e=__webpack_require__(141),i=coreApis.utils.urls;const o={name:"downloadDanmaku",displayName:"下载弹幕",description:{"zh-CN":"启用下载弹幕支持, 在视频和番剧页面中可从功能面板里下载弹幕."},tags:[componentsTags.video],entry:none,reload:none,unload:none,plugin:{displayName:"下载视频 - 下载弹幕支持",setup:({addData:t})=>{t("downloadVideo.assets",(async t=>{const{getBlobByType:i}=await Promise.resolve().then(__webpack_require__.bind(__webpack_require__,845));t.push({name:"downloadDanmaku",displayName:"下载弹幕",getAssets:async(t,o)=>{const{type:n,enabled:r}=o;if(!r)return[];const a=e.Toast.info("获取弹幕中...","下载弹幕");let s=0;const c=await Promise.allSettled(t.map((async e=>{const o=await i(n,e.input);return s++,a.message=`获取弹幕中... (${s}/${t.length})`,{name:`${e.input.title}.${n}`,data:o}}))),l=c.filter((t=>"fulfilled"===t.status)),d=c.filter((t=>"rejected"===t.status));return a.message=`获取完成. 成功 ${l.length} 个, 失败 ${d.length} 个.`,l.map((t=>t.value))},component:()=>Promise.resolve().then(__webpack_require__.bind(__webpack_require__,637)).then((t=>t.default))})}))}},urlInclude:i.videoAndBangumiUrls,widget:{condition:t.hasVideo,component:()=>Promise.resolve().then(__webpack_require__.bind(__webpack_require__,24)).then((t=>t.default))}}}(),__webpack_exports__=__webpack_exports__.component,__webpack_exports__}()}));