!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["video/player/remember-speed"]=t():e["video/player/remember-speed"]=t()}(self,(function(){return function(){"use strict";var e,t,n={764:function(e,t,n){n.r(t),n.d(t,{VideoSpeedController:function(){return b},calcOrder:function(){return u},errorMessageDuration:function(){return c},maxValue:function(){return l},minValue:function(){return d},stepValue:function(){return p}});var i=coreApis.observer,a=n(407),s=coreApis.spinQuery,r=coreApis.utils.sort;function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const d=.0625,l=16,p=.5,c=2e3,u=e=>(1e4*(l-e)).toString(),m=(e=unsafeWindow.aid)=>{if(!e)throw new Error("aid is unknown");return e},v=(0,a.getComponentSettings)("rememberVideoSpeed"),f=v.options;class b{static get extendedSupportedRates(){return Array.from(new Set(f.extendList)).sort((0,r.ascendingSort)())}static get supportedRates(){return f.extend?[...b.nativeSupportedRates,...b.extendedSupportedRates].sort((0,r.ascendingSort)()):b.nativeSupportedRates}static get fallbackVideoSpeed(){return v.enabled?parseFloat(f.speed):null}static formatSpeedText(e){return 1===e?"倍速":Math.trunc(e)===e?`${e}.0x`:`${e}x`}static getRememberSpeed(e){for(const[t,n]of Object.entries(f.individualRememberList))if(n.some((t=>t===m(e))))return parseFloat(t);return null}static forgetSpeed(e){e=m(e);let t=-1;for(const n of Object.values(f.individualRememberList))if(t=n.indexOf(e),-1!==t){n.splice(t,1);break}return-1!==t}static rememberSpeed(e,t=!1,n){n=m(n);(b.forgetSpeed(n)||t)&&(f.individualRememberList[e]||(f.individualRememberList[e]=[]),f.individualRememberList[e].push(n))}static async getInstance(e,t){const n=await(0,s.select)(`.${b.classNameMap.speedContainer}`),i=await(0,s.select)(`.${b.classNameMap.video} video`);if(!n)throw new Error("speed container element not found!");if(!i)throw new Error("video element not found!");return new b(n,i,e,t)}constructor(e,t,n,i){this.containerElement=e,this.videoElement=t,o(this,"menuListElement",void 0),o(this,"nameBtn",void 0),o(this,"nativeSpeedVal",void 0),o(this,"previousSpeedVal",void 0);const a=b.instanceMap.get(e);if(a&&(!n||a.previousSpeedVal===n)&&(!i||a.nativeSpeedVal===i))return a;this.previousSpeedVal=n,this.nativeSpeedVal=i??(n&&b.nativeSupportedRates.includes(n)?n:1),this.nameBtn=this.containerElement.querySelector(`.${b.classNameMap.speedNameBtn}`),this.menuListElement=this.containerElement.querySelector(`.${b.classNameMap.speedMenuList}`),b.instanceMap.set(e,this)}get playbackRate(){return this.videoElement.playbackRate}getSpeedMenuItem(e){return e?this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}[data-value="${e}"]`):this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}.${b.classNameMap.active}`)}observe(){(0,i.allMutationsOn)(this.menuListElement,(e=>{let[t,n]=[void 0,void 0];e.forEach((e=>{const i=e.target;if(!i.classList.contains(b.classNameMap.active))return void(t=parseFloat(i.dataset.value??"1"));n=parseFloat(i.dataset.value??"1");let a=!1;b.nativeSupportedRates.includes(n)&&(this.nativeSpeedVal=n,a=!0),this.containerElement.dispatchEvent(new CustomEvent("changed",{detail:{speed:n,isNativeSpeed:a,previousSpeed:this.previousSpeedVal}})),f.extend&&b.nativeSupportedRates.includes(n)&&this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}.extended.${b.classNameMap.active}`)?.classList.remove(b.classNameMap.active),v.enabled&&(f.individualRemember?b.rememberSpeed(n,n!==b.fallbackVideoSpeed):f.speed=n.toString())})),t&&t!==n&&(this.previousSpeedVal=t)}))}toggleVideoSpeed(e="smart",t=!1){switch(e){case"smart":1===this.playbackRate?this.setVideoSpeed(this.previousSpeedVal):this.reset(t);break;case"classic":this.setVideoSpeed(this.previousSpeedVal)}}reset(e=!1){if(e){const{fallbackVideoSpeed:e}=b;if(!e)return;b.forgetSpeed(),this.setVideoSpeed(e)}else this.setVideoSpeed(1)}setVideoSpeed(e){e&&this.getSpeedMenuItem(e).click()}setExtendedVideoSpeed(e){b.nativeSupportedRates.includes(e)?this.getSpeedMenuItem(e).click():this.forceUpdate(e)}forceUpdate(e){this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}[data-value="${this.playbackRate}"]`)?.classList.remove(b.classNameMap.active),this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}[data-value="${e}"]`)?.classList.add(b.classNameMap.active),this.videoElement.playbackRate=e,this.containerElement.classList.remove(b.classNameMap.show),this.nameBtn.innerText=b.formatSpeedText(e)}}o(b,"classNameMap",{speedMenuList:"bilibili-player-video-btn-speed-menu",speedMenuItem:"bilibili-player-video-btn-speed-menu-list",speedNameBtn:"bilibili-player-video-btn-speed-name",speedContainer:"bilibili-player-video-btn-speed",active:"bilibili-player-active",show:"bilibili-player-speed-show",video:"bilibili-player-video"}),o(b,"nativeSupportedRates",[.5,.75,1,1.25,1.5,2]),o(b,"instanceMap",new WeakMap),o(b,"init",lodash.once((()=>{let e,t,a=1;(0,i.videoChange)((async()=>{const{getExtraSpeedMenuItemElements:i}=await Promise.resolve().then(n.bind(n,891)),s=await b.getInstance(e,a);t=s.containerElement,t.classList.contains("extended")||(f.extend&&(s.menuListElement.prepend(...await i()),s.menuListElement.querySelectorAll(`.${b.classNameMap.speedMenuItem}[data-value]:not(.extended)`).forEach((e=>{e.style.order=u(parseFloat(e.getAttribute("data-value")))})),s.menuListElement.addEventListener("click",(e=>{const t=e.target,n=parseFloat(t.dataset.value);e.target.classList.contains("extended")&&s.setExtendedVideoSpeed(n),b.extendedSupportedRates.includes(s.playbackRate)&&s.nativeSpeedVal===n&&s.forceUpdate(n)}))),s.observe(),t.addEventListener("changed",(({detail:{speed:t,isNativeSpeed:n}})=>{e=t,n&&(a=t)})),setTimeout((()=>{s.setVideoSpeed(v.enabled&&f.individualRemember&&b.getRememberSpeed()||b.fallbackVideoSpeed||e)}),100),t.classList.add("extended"))}))})))},891:function(e,t,n){n.r(t),n.d(t,{getExtraSpeedMenuItemElements:function(){return d}});var i=n(407),a=coreApis.style,s=coreApis.utils.log;const{options:r}=(0,i.getComponentSettings)("rememberVideoSpeed");let o=r.extendList;const d=async()=>{const{VideoSpeedController:e,calcOrder:t,minValue:i,maxValue:d,stepValue:l,errorMessageDuration:p}=await Promise.resolve().then(n.bind(n,764)),c=n=>{const i=document.createElement("li");i.innerText=e.formatSpeedText(n),i.classList.add(e.classNameMap.speedMenuItem,"extended"),i.dataset.value=n.toString(),i.style.order=t(n);const a=document.createElement("i");return a.classList.add("mdi","mdi-close-circle"),a.addEventListener("click",(()=>{lodash.pull(o,n),i.remove()})),i.append(a),i};(0,a.addStyle)(`\n  .${e.classNameMap.speedContainer} .${e.classNameMap.speedMenuItem}:first-child .mdi-playlist-plus {\n    font-size: 1.5em;\n  }\n  .${e.classNameMap.speedContainer} .${e.classNameMap.speedMenuItem}:first-child input {\n    font-size: inherit;\n    color: inherit;\n    line-height: inherit;\n    background: transparent;\n    outline: none;\n    width: 100%;\n    border: none;\n    text-align: center;\n  }\n  .${e.classNameMap.speedMenuItem} .mdi-close-circle {\n    color: inherit;\n    opacity: 0.5;\n    display: none;\n    position: absolute;\n    right: 4px;\n  }\n  .${e.classNameMap.speedMenuItem}:not(.${e.classNameMap.active}):hover .mdi-close-circle {\n    display: inline;\n  }\n  .${e.classNameMap.speedMenuItem} .mdi-close-circle:hover {\n    opacity: 1;\n    transition: all .3s;\n  }\n  /* https://stackoverflow.com/a/4298216 */\n  /* Chrome */\n  .add-speed-entry::-webkit-outer-spin-button,\n  .add-speed-entry::-webkit-inner-spin-button {\n    -webkit-appearance: none;\n    margin: 0;\n  }\n  /* Firefox */\n  .add-speed-entry[type=number] {\n    -moz-appearance:textfield;\n  }\n  .${e.classNameMap.speedMenuList} {\n    display: flex;\n    flex-direction: column;\n    overflow-y: auto;\n    max-height: 360px;\n  }\n  `,"extend-video-speed-style");const u=e.extendedSupportedRates.map((e=>c(e))).reverse();return u.unshift((()=>{const t=t=>{const n=(()=>{const t=e.supportedRates.slice(-1)[0]+l;return t>d?null:t})();t.setAttribute("min",n?t.value=n.toString():(t.value="",i.toString()))},n=document.createElement("li");n.classList.add(e.classNameMap.speedMenuItem);const a=document.createElement("i");a.classList.add("mdi","mdi-playlist-plus");const u=document.createElement("input");return u.classList.add("add-speed-entry"),u.setAttribute("type","number"),u.setAttribute("max",d.toString()),u.setAttribute("step",l.toString()),u.setAttribute("title","增加新的倍速值"),t(u),u.addEventListener("keydown",(a=>{if("Enter"===a.key){const a=parseFloat(u.value);if(!isFinite(a))return(0,s.logError)("无效的倍速值",p),!1;if(a<i)return(0,s.logError)("倍速值太小了",p),!1;if(a>d)return(0,s.logError)("倍速值太大了",p),!1;if(e.supportedRates.includes(a))return(0,s.logError)("不能重复添加已有的倍速值",p),!1;o.push(a),r.extendList=e.extendedSupportedRates,o=r.extendList;let l=n.nextElementSibling;for(;!l.dataset.value||parseFloat(l.dataset.value)>e.nativeSupportedRates.slice(-1)[0]&&a<parseFloat(l.dataset.value);)l=l.nextElementSibling;l.before(c(a)),t(u)}return!0})),n.prepend(a,u),u.style.display="none",n.addEventListener("mouseenter",(()=>{t(u),u.style.display="inline",a.style.display="none",u.focus()})),n.addEventListener("mouseleave",(()=>{a.style.display="inline",u.style.display="none"})),n})()),u}},407:function(e){e.exports=coreApis.settings}},i={};function a(e){var t=i[e];if(void 0!==t)return t.exports;var s=i[e]={exports:{}};return n[e](s,s.exports,a),s.exports}t=Object.getPrototypeOf?function(e){return Object.getPrototypeOf(e)}:function(e){return e.__proto__},a.t=function(n,i){if(1&i&&(n=this(n)),8&i)return n;if("object"==typeof n&&n){if(4&i&&n.__esModule)return n;if(16&i&&"function"==typeof n.then)return n}var s=Object.create(null);a.r(s);var r={};e=e||[null,t({}),t([]),t(t)];for(var o=2&i&&n;"object"==typeof o&&!~e.indexOf(o);o=t(o))Object.getOwnPropertyNames(o).forEach((function(e){r[e]=function(){return n[e]}}));return r.default=function(){return n},a.d(s,r),s},a.d=function(e,t){for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return function(){a.d(s,{component:function(){return t}});var e=coreApis.utils.urls;const t={name:"rememberVideoSpeed",displayName:"倍速记忆",author:{name:"JLoeve",link:"https://github.com/LonelySteve"},description:{"zh-CN":"记忆上次选择的视频播放速度, 还可以使用更多倍速来扩展原生倍速菜单."},tags:[componentsTags.video],urlInclude:e.playerUrls,entry:async()=>{const{VideoSpeedController:e}=await Promise.resolve().then(a.bind(a,764));return e.init(),e},plugin:{displayName:"倍速记忆 - 快捷键支持",setup:async({addData:e})=>{const{getComponentSettings:t}=await Promise.resolve().then(a.t.bind(a,407,23)),n=async(e,t)=>{const{VideoSpeedController:n}=await Promise.resolve().then(a.bind(a,764)),i=await n.getInstance();t(i,n.supportedRates),e.showTip(`${i.playbackRate}x`,"mdi-fast-forward")};e("keymap.actions",(e=>{e.videoSpeedIncrease={displayName:"提高倍速",run:e=>(n(e,((e,t)=>{e.setVideoSpeed(t.find((t=>t>e.playbackRate))||t[t.length-1])})),!0)},e.videoSpeedDecrease={displayName:"降低倍速",run:e=>(n(e,((e,t)=>{e.setVideoSpeed([...t].reverse().find((t=>t<e.playbackRate))||t[0])})),!0)},e.videoSpeedReset={displayName:"重置倍速",run:e=>(n(e,(e=>{e.toggleVideoSpeed()})),!0)},t("rememberVideoSpeed").options.individualRemember&&(e.videoSpeedForget={displayName:"清除当前倍速记忆",run:e=>(n(e,(e=>{e.reset(!0)})),!0)})})),e("keymap.presets",(e=>{e.videoSpeedIncrease="shift > 》 arrowUp",e.videoSpeedDecrease="shift < 《 arrowDown",e.videoSpeedReset="shift ? ？",e.videoSpeedForget="shift : ："}))}},options:{speed:{displayName:"记忆的速度",defaultValue:"1.0",hidden:!0},extend:{displayName:"扩展倍速菜单",defaultValue:!0},extendList:{displayName:"扩展倍速列表",defaultValue:[2.5,3],hidden:!0},individualRemember:{displayName:"各视频分别记忆",defaultValue:!1,hidden:!0},individualRememberList:{displayName:"分别记忆倍速列表",defaultValue:{},hidden:!0}}}}(),s=s.component}()}));