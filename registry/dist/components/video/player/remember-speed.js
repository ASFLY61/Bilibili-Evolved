!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["video/player/remember-speed"]=t():e["video/player/remember-speed"]=t()}(self,(function(){return function(){"use strict";var e={723:function(e,t,n){n.r(t),n.d(t,{VideoSpeedController:function(){return b},calcOrder:function(){return u},errorMessageDuration:function(){return c},maxValue:function(){return l},minValue:function(){return o},stepValue:function(){return p}});var a=coreApis.observer,i=n(407),s=coreApis.spinQuery,r=coreApis.utils.sort;function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const o=.0625,l=16,p=.5,c=2e3,u=e=>(1e4*(l-e)).toString(),m=(e=unsafeWindow.aid)=>{if(!e)throw new Error("aid is unknown");return e},v=(0,i.getComponentSettings)("rememberVideoSpeed"),f=v.options;class b{static get extendedSupportedRates(){return Array.from(new Set(f.extendList)).sort((0,r.ascendingSort)())}static get supportedRates(){return f.extend?[...b.nativeSupportedRates,...b.extendedSupportedRates].sort((0,r.ascendingSort)()):b.nativeSupportedRates}static get fallbackVideoSpeed(){return v.enabled?parseFloat(f.speed):null}static formatSpeedText(e){return 1===e?"倍数":Math.trunc(e)===e?`${e}.0x`:`${e}x`}static getRememberSpeed(e){for(const[t,n]of Object.entries(f.individualRememberList))if(n.some((t=>t===m(e))))return parseFloat(t);return null}static forgetSpeed(e){e=m(e);let t=-1;for(const n of Object.values(f.individualRememberList))if(t=n.indexOf(e),-1!==t){n.splice(t,1);break}return-1!==t}static rememberSpeed(e,t=!1,n){n=m(n);(b.forgetSpeed(n)||t)&&(f.individualRememberList[e]||(f.individualRememberList[e]=[]),f.individualRememberList[e].push(n))}static async getInstance(e,t){const n=await(0,s.select)(`.${b.classNameMap.speedContainer}`),a=await(0,s.select)(`.${b.classNameMap.video} video`);if(!n)throw new Error("speed container element not found!");if(!a)throw new Error("video element not found!");return new b(n,a,e,t)}constructor(e,t,n,a){this.containerElement=e,this.videoElement=t,d(this,"menuListElement",void 0),d(this,"nameBtn",void 0),d(this,"nativeSpeedVal",void 0),d(this,"previousSpeedVal",void 0);const i=b.instanceMap.get(e);if(i&&(!n||i.previousSpeedVal===n)&&(!a||i.nativeSpeedVal===a))return i;this.previousSpeedVal=n,this.nativeSpeedVal=a??(n&&b.nativeSupportedRates.includes(n)?n:1),this.nameBtn=this.containerElement.querySelector(`.${b.classNameMap.speedNameBtn}`),this.menuListElement=this.containerElement.querySelector(`.${b.classNameMap.speedMenuList}`),b.instanceMap.set(e,this)}get playbackRate(){return this.videoElement.playbackRate}getSpeedMenuItem(e){return e?this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}[data-value="${e}"]`):this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}.${b.classNameMap.active}`)}observe(){(0,a.allMutationsOn)(this.menuListElement,(e=>{let[t,n]=[void 0,void 0];e.forEach((e=>{const a=e.target;if(!a.classList.contains(b.classNameMap.active))return void(t=parseFloat(a.dataset.value??"1"));n=parseFloat(a.dataset.value??"1");let i=!1;b.nativeSupportedRates.includes(n)&&(this.nativeSpeedVal=n,i=!0),this.containerElement.dispatchEvent(new CustomEvent("changed",{detail:{speed:n,isNativeSpeed:i,previousSpeed:this.previousSpeedVal}})),f.extend&&b.nativeSupportedRates.includes(n)&&this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}.extended.${b.classNameMap.active}`)?.classList.remove(b.classNameMap.active),v.enabled&&(f.individualRemember?b.rememberSpeed(n,n!==b.fallbackVideoSpeed):f.speed=n.toString())})),t&&t!==n&&(this.previousSpeedVal=t)}))}toggleVideoSpeed(e="smart",t=!1){switch(e){case"smart":1===this.playbackRate?this.setVideoSpeed(this.previousSpeedVal):this.reset(t);break;case"classic":this.setVideoSpeed(this.previousSpeedVal)}}reset(e=!1){if(e){const{fallbackVideoSpeed:e}=b;if(!e)return;b.forgetSpeed(),this.setVideoSpeed(e)}else this.setVideoSpeed(1)}setVideoSpeed(e){e&&this.getSpeedMenuItem(e).click()}setExtendedVideoSpeed(e){b.nativeSupportedRates.includes(e)?this.getSpeedMenuItem(e).click():this.forceUpdate(e)}forceUpdate(e){this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}[data-value="${this.playbackRate}"]`)?.classList.remove(b.classNameMap.active),this.menuListElement.querySelector(`.${b.classNameMap.speedMenuItem}[data-value="${e}"]`)?.classList.add(b.classNameMap.active),this.videoElement.playbackRate=e,this.containerElement.classList.remove(b.classNameMap.show),this.nameBtn.innerText=b.formatSpeedText(e)}}d(b,"classNameMap",{speedMenuList:"bilibili-player-video-btn-speed-menu",speedMenuItem:"bilibili-player-video-btn-speed-menu-list",speedNameBtn:"bilibili-player-video-btn-speed-name",speedContainer:"bilibili-player-video-btn-speed",active:"bilibili-player-active",show:"bilibili-player-speed-show",video:"bilibili-player-video"}),d(b,"nativeSupportedRates",[.5,.75,1,1.25,1.5,2]),d(b,"instanceMap",new WeakMap),d(b,"init",lodash.once((()=>{let e,t,i=1;(0,a.videoChange)((async()=>{const{getExtraSpeedMenuItemElements:a}=await Promise.resolve().then(n.bind(n,268)),s=await b.getInstance(e,i);t=s.containerElement,t.classList.contains("extended")||(f.extend&&(s.menuListElement.prepend(...await a()),s.menuListElement.querySelectorAll(`.${b.classNameMap.speedMenuItem}[data-value]:not(.extended)`).forEach((e=>{e.style.order=u(parseFloat(e.getAttribute("data-value")))})),s.menuListElement.addEventListener("click",(e=>{const t=e.target,n=parseFloat(t.dataset.value);e.target.classList.contains("extended")&&s.setExtendedVideoSpeed(n),b.extendedSupportedRates.includes(s.playbackRate)&&s.nativeSpeedVal===n&&s.forceUpdate(n)}))),s.observe(),t.addEventListener("changed",(({detail:{speed:t,isNativeSpeed:n}})=>{e=t,n&&(i=t)})),setTimeout((()=>{s.setVideoSpeed(v.enabled&&f.individualRemember&&b.getRememberSpeed()||b.fallbackVideoSpeed||e)}),100),t.classList.add("extended"))}))})))},268:function(e,t,n){n.r(t),n.d(t,{getExtraSpeedMenuItemElements:function(){return o}});var a=n(407),i=coreApis.style,s=coreApis.utils.log;const{options:r}=(0,a.getComponentSettings)("rememberVideoSpeed");let d=r.extendList;const o=async()=>{const{VideoSpeedController:e,calcOrder:t,minValue:a,maxValue:o,stepValue:l,errorMessageDuration:p}=await Promise.resolve().then(n.bind(n,723)),c=n=>{const a=document.createElement("li");a.innerText=e.formatSpeedText(n),a.classList.add(e.classNameMap.speedMenuItem,"extended"),a.dataset.value=n.toString(),a.style.order=t(n);const i=document.createElement("i");return i.classList.add("mdi","mdi-close-circle"),i.addEventListener("click",(()=>{lodash.pull(d,n),a.remove()})),a.append(i),a};(0,i.addStyle)(`\n  .${e.classNameMap.speedContainer} .${e.classNameMap.speedMenuItem}:first-child .mdi-playlist-plus {\n    font-size: 1.5em;\n  }\n  .${e.classNameMap.speedContainer} .${e.classNameMap.speedMenuItem}:first-child input {\n    font-size: inherit;\n    color: inherit;\n    line-height: inherit;\n    background: transparent;\n    outline: none;\n    width: 100%;\n    border: none;\n    text-align: center;\n  }\n  .${e.classNameMap.speedMenuItem} .mdi-close-circle {\n    color: inherit;\n    opacity: 0.5;\n    display: none;\n    position: absolute;\n    right: 4px;\n  }\n  .${e.classNameMap.speedMenuItem}:not(.${e.classNameMap.active}):hover .mdi-close-circle {\n    display: inline;\n  }\n  .${e.classNameMap.speedMenuItem} .mdi-close-circle:hover {\n    opacity: 1;\n    transition: all .3s;\n  }\n  /* https://stackoverflow.com/a/4298216 */\n  /* Chrome */\n  .add-speed-entry::-webkit-outer-spin-button,\n  .add-speed-entry::-webkit-inner-spin-button {\n    -webkit-appearance: none;\n    margin: 0;\n  }\n  /* Firefox */\n  .add-speed-entry[type=number] {\n    -moz-appearance:textfield;\n  }\n  .${e.classNameMap.speedMenuList} {\n    display: flex;\n    flex-direction: column;\n    overflow-y: auto;\n    max-height: 360px;\n  }\n  `,"extend-video-speed-style");const u=e.extendedSupportedRates.map((e=>c(e))).reverse();return u.unshift((()=>{const t=t=>{const n=(()=>{const t=e.supportedRates.slice(-1)[0]+l;return t>o?null:t})();t.setAttribute("min",n?t.value=n.toString():(t.value="",a.toString()))},n=document.createElement("li");n.classList.add(e.classNameMap.speedMenuItem);const i=document.createElement("i");i.classList.add("mdi","mdi-playlist-plus");const u=document.createElement("input");return u.classList.add("add-speed-entry"),u.setAttribute("type","number"),u.setAttribute("max",o.toString()),u.setAttribute("step",l.toString()),u.setAttribute("title","增加新的倍数值"),t(u),u.addEventListener("keydown",(i=>{if("Enter"===i.key){const i=parseFloat(u.value);if(!isFinite(i))return(0,s.logError)("无效的倍数值",p),!1;if(i<a)return(0,s.logError)("倍数值太小了",p),!1;if(i>o)return(0,s.logError)("倍数值太大了",p),!1;if(e.supportedRates.includes(i))return(0,s.logError)("不能重复添加已有的倍数值",p),!1;d.push(i),r.extendList=e.extendedSupportedRates,d=r.extendList;let l=n.nextElementSibling;for(;!l.dataset.value||parseFloat(l.dataset.value)>e.nativeSupportedRates.slice(-1)[0]&&i<parseFloat(l.dataset.value);)l=l.nextElementSibling;l.before(c(i)),t(u)}return!0})),n.prepend(i,u),u.style.display="none",n.addEventListener("mouseenter",(()=>{t(u),u.style.display="inline",i.style.display="none",u.focus()})),n.addEventListener("mouseleave",(()=>{i.style.display="inline",u.style.display="none"})),n})()),u}},407:function(e){e.exports=coreApis.settings}},t={};function n(a){var i=t[a];if(void 0!==i)return i.exports;var s=t[a]={exports:{}};return e[a](s,s.exports,n),s.exports}n.d=function(e,t){for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};return function(){n.d(a,{component:function(){return t}});var e=coreApis.utils.urls;const t={name:"rememberVideoSpeed",displayName:"记忆上次播放速度",description:{"zh-CN":"记忆上次选择的视频播放速度, 还可以使用更多倍速来扩展原生倍速菜单."},tags:[componentsTags.video],enabledByDefault:!0,urlInclude:e.playerUrls,entry:async()=>{const{VideoSpeedController:e}=await Promise.resolve().then(n.bind(n,723));return e.init(),e},options:{speed:{displayName:"记忆的速度",defaultValue:"1.0",hidden:!0},extend:{displayName:"扩展倍速菜单",defaultValue:!0},extendList:{displayName:"扩展倍速列表",defaultValue:[2.5,3],hidden:!0},individualRemember:{displayName:"各视频分别记忆",defaultValue:!1,hidden:!0},individualRememberList:{displayName:"分别记忆倍速列表",defaultValue:{},hidden:!0}}}}(),a=a.component}()}));